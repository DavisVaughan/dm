---
title: "Zoomed table in `def`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{zoomed_table_in_def}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(width = 120, tibble.width = 100)
```

```{r setup, include = FALSE}
library(dm)
library(dplyr)
library(nycflights13)
library(rlang)
```

Without a zoomed table, `def` could look like this:

```{r}
key_tracker_zoom <- tibble(table = character(), key_tracker_zoom = list())

dm:::cdm_get_def(cdm_nycflights13()) %>% 
  left_join(key_tracker_zoom, by = "table")
```

## Zooming to airports

### {dm} code

```{r}
cdm_nycflights13() %>% dm:::cdm_zoom_to_tbl(airports)
```

### state of `def`

```{r}
key_tracker_zoom <- tibble(
  table = "airports", 
  key_tracker_zoom = list(set_names(dm:::get_all_keys(cdm_nycflights13(), "airports")))
  )
key_tracker_zoom %>% pull(key_tracker_zoom)
# names of columns are the potential new names; adapted when manipulating the zoomed table

dm:::cdm_get_def(cdm_nycflights13()) %>% 
  mutate(zoom = if_else(
    table == "airports",
    data,
    list(NULL)
  )) %>% 
  left_join(key_tracker_zoom, by = "table")
```

## Filtering the zoomed table (airports)

### {dm} code

```{r, eval=FALSE}
cdm_nycflights13() %>% dm:::cdm_zoom_to_tbl(airports) %>% filter(lat < 40.)
```

### state of `def`

We are changing the column `filters` slightly, adding a new column in the dataframe: a logical column `zoomed`. This indicates for each filter condition, if it is an "old" one or a new one.
`select()` and `rename()` will (for now) be forbidden on filtered tables, independent if `zoomed` is `TRUE` or `FALSE`.
`cdm_apply_filters()` and the methods for `tbl()`, `[[.dm()`, `$.dm()` need to (at least) be adapted for a `zoomed_dm`.

```{r}
key_tracker_zoom <- tibble(
  table = "airports", 
  key_tracker_zoom = list(set_names(dm:::get_all_keys(cdm_nycflights13(), "airports")))
  )
key_tracker_zoom %>% pull(key_tracker_zoom)

dm:::cdm_get_def(cdm_nycflights13()) %>% 
  mutate(
    zoom = if_else(
      table == "airports",
      data,
      list(NULL)),
    filters = if_else(
      table == "airports",
      vctrs::list_of(dm:::new_filter(list(quo(lat < 40.)))),
      vctrs::list_of(dm:::new_filter()))
  ) %>% 
  left_join(key_tracker_zoom, by = "table")
```

## Changing the primary key column name from "faa" to "code"

### {dm} code

```{r, eval=FALSE}
cdm_nycflights13() %>% 
  dm:::cdm_zoom_to_tbl(airports) %>% 
  filter(lat < 40.) %>% 
  rename(code = faa)
```

### state of `def`

```{r}
key_tracker_zoom <- tibble(
  table = "airports", 
  key_tracker_zoom = list(set_names(dm:::get_all_keys(cdm_nycflights13(), "airports"), "code"))
  )
key_tracker_zoom %>% pull(key_tracker_zoom)

dm:::cdm_get_def(cdm_nycflights13()) %>% 
  mutate(
    zoom = if_else(
      table == "airports",
      data,
      list(NULL)),
    filters = if_else(
      table == "airports",
      vctrs::list_of(dm:::new_filter(list(quo(lat < 40.)))),
      vctrs::list_of(dm:::new_filter()))
  ) %>% 
  left_join(key_tracker_zoom, by = "table")
```

## Inserting a new table "airports_new"

### {dm} code

```{r, eval=FALSE}
cdm_nycflights13() %>% 
  dm:::cdm_zoom_to_tbl(airports) %>% 
  filter(lat < 40.) %>% 
  rename(code = faa) %>% 
  cdm_insert_zoomed_tbl(airports_new)
```

### state of `def`

All keys that could be tracked are staying, including FKs pointing to the old table.
New PK has now the new name.
Display accent is not copied.

```{r}
key_tracker_zoom <- tibble(table = character(), key_tracker_zoom = list())
airports_new <- airports %>% 
  rename(code = faa)

(new_def <- cdm_add_tbl(cdm_nycflights13(), airports_new) %>%
  dm:::cdm_get_def() %>% 
  mutate(
    filters = if_else(
      table == "airports_new",
      vctrs::list_of(dm:::new_filter(list(quo(lat < 40.)))),
      vctrs::list_of(dm:::new_filter())),
    pks = if_else(
      table == "airports_new",
      vctrs::list_of(dm:::new_pk(list("code"))),
      pks
      )
    ) %>% 
  left_join(key_tracker_zoom, by = "table")
)

cdm_draw(dm:::new_dm3(new_def))
```

## Updating "airports" with zoomed table

### {dm} code

```{r, eval=FALSE}
cdm_nycflights13() %>% 
  dm:::cdm_zoom_to_tbl(airports) %>% 
  filter(lat < 40.) %>% 
  rename(code = faa) %>% 
  cdm_update_zoomed_tbl(airports_new)
```

### state of `def`

All keys that could be tracked.
New PK has now the new name.
Display accent stays the same.

```{r}
key_tracker_zoom <- tibble(table = character(), key_tracker_zoom = list())
airports_new <- airports %>% 
  rename(code = faa)

(new_def <- dm:::cdm_get_def(cdm_nycflights13()) %>% 
  mutate(
    data = if_else(
      table == "airports",
      list(airports_new),
      data
    ),
    filters = if_else(
      table == "airports",
      vctrs::list_of(dm:::new_filter(list(quo(lat < 40.)))),
      vctrs::list_of(dm:::new_filter())),
    pks = if_else(
      table == "airports",
      vctrs::list_of(dm:::new_pk(list("code"))),
      pks
      )
    ) %>% 
  left_join(key_tracker_zoom, by = "table")
)

cdm_draw(dm:::new_dm3(new_def))
```







## Zooming to flights

It is slightly different when zooming to table "flights", cause FKs are pointing away from it, instead of towards it.

### {dm} code

```{r}
cdm_nycflights13() %>% dm:::cdm_zoom_to_tbl(flights)
```

### state of `def`

```{r}
key_tracker_zoom <- tibble(
  table = "flights", 
  key_tracker_zoom = list(set_names(dm:::get_all_keys(cdm_nycflights13(), "flights")))
  )
key_tracker_zoom %>% pull(key_tracker_zoom)
# names of columns are the potential new names; adapted when manipulating the zoomed table

dm:::cdm_get_def(cdm_nycflights13()) %>% 
  mutate(zoom = if_else(
    table == "flights",
    data,
    list(NULL)
  )) %>% 
  left_join(key_tracker_zoom, by = "table")
```

## Filtering the zoomed table (flights)

### {dm} code

```{r, eval=FALSE}
cdm_nycflights13() %>% dm:::cdm_zoom_to_tbl(flights) %>% filter(dep_time < 1200)
```

### state of `def`

```{r}
key_tracker_zoom <- tibble(
  table = "flights", 
  key_tracker_zoom = list(set_names(dm:::get_all_keys(cdm_nycflights13(), "flights")))
  )
key_tracker_zoom %>% pull(key_tracker_zoom)

dm:::cdm_get_def(cdm_nycflights13()) %>% 
  mutate(
    zoom = if_else(
      table == "flights",
      data,
      list(NULL)),
    filters = if_else(
      table == "flights",
      vctrs::list_of(dm:::new_filter(list(quo(dep_time < 1200)))),
      vctrs::list_of(dm:::new_filter()))
  ) %>% 
  left_join(key_tracker_zoom, by = "table")
```

## Changing the foreign key column referencing planes from "tailnum" to "plane_code"

### {dm} code

```{r, eval=FALSE}
cdm_nycflights13() %>% 
  dm:::cdm_zoom_to_tbl(flights) %>% 
  filter(dep_time < 1200) %>% 
  rename(plane_code = tailnum)
```

### state of `def`

```{r}
key_tracker_zoom <- tibble(
  table = "flights", 
  key_tracker_zoom = list(set_names(dm:::get_all_keys(cdm_nycflights13(), "flights"), c("carrier", "origin", "plane_code")))
  )
key_tracker_zoom %>% pull(key_tracker_zoom)

dm:::cdm_get_def(cdm_nycflights13()) %>% 
  mutate(
    zoom = if_else(
      table == "flights",
      data,
      list(NULL)),
    filters = if_else(
      table == "flights",
      vctrs::list_of(dm:::new_filter(list(quo(dep_time < 1200)))),
      vctrs::list_of(dm:::new_filter()))
  ) %>% 
  left_join(key_tracker_zoom, by = "table")
```

## Inserting a new table "flights_new"

### {dm} code

```{r, eval=FALSE}
cdm_nycflights13() %>% 
  dm:::cdm_zoom_to_tbl(flights) %>% 
  filter(dep_time < 1200) %>% 
  rename(plane_code = tailnum) %>% 
  cdm_insert_zoomed_tbl(flights_new)
```

### state of `def`

FKs pointing away from the old table are also pointing away from the new one.
PK would be copied, but is not available for flights.
Display accent is not copied.

```{r}
key_tracker_zoom <- tibble(table = character(), key_tracker_zoom = list())
flights_new <- flights %>% 
  rename(plane_code = tailnum)

(new_def <- cdm_add_tbl(cdm_nycflights13(), flights_new) %>%
  dm:::cdm_get_def() %>% 
  mutate(
    filters = if_else(
      table == "flights_new",
      vctrs::list_of(dm:::new_filter(list(quo(dep_time < 1200)))),
      vctrs::list_of(dm:::new_filter())),
    fks = case_when(
      table == "planes" ~ vctrs::list_of(dm:::new_fk(table = c("flights_new", "flights"), column = list("plane_code", "tailnum"))),
      table == "airports" ~ vctrs::list_of(dm:::new_fk(table = c("flights_new", "flights"), column = list("origin", "origin"))),
      table == "airlines" ~ vctrs::list_of(dm:::new_fk(table = c("flights_new", "flights"), column = list("carrier", "carrier"))),
      TRUE ~ fks)
    ) %>% 
  left_join(key_tracker_zoom, by = "table")
)

cdm_draw(dm:::new_dm3(new_def))
```

## Updating "flights" with zoomed table

### {dm} code

```{r, eval=FALSE}
cdm_nycflights13() %>% 
  dm:::cdm_zoom_to_tbl(airports) %>% 
  filter(dep_time < 1200) %>% 
  rename(plane_code = tailnum) %>% 
  cdm_update_zoomed_tbl(flights_new)
```

### state of `def`

FKs pointing to the old table are also pointing to the new one.
New PK has now the new name.
Display accent stays the same.

```{r}
key_tracker_zoom <- tibble(table = character(), key_tracker_zoom = list())
flights_new <- flights %>% 
  rename(plane_code = tailnum)

(new_def <- dm:::cdm_get_def(cdm_nycflights13()) %>% 
  mutate(
    data = if_else(
      table == "flights",
      list(flights_new),
      data
    ),
    filters = if_else(
      table == "flights",
      vctrs::list_of(dm:::new_filter(list(quo(dep_time < 1200)))),
      vctrs::list_of(dm:::new_filter())),
    fks = if_else(
      table == "planes",
      vctrs::list_of(dm:::new_fk(table = "flights", column = list("plane_code"))),
      fks
      )
    ) %>% 
  left_join(key_tracker_zoom, by = "table")
)

cdm_draw(dm:::new_dm3(new_def))
```


