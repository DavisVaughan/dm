<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Create a dm object from a database • dm</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Create a dm object from a database">
<meta property="og:description" content="dm">
<meta property="og:image" content="https://krlmlr.github.io/dm/logo.png">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">dm</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.1.6.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/dm.html">Intro</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/howto-dm-db.html">Create a dm object from a database</a>
    </li>
    <li>
      <a href="../articles/howto-dm-df.html">Create a dm object from data frames</a>
    </li>
    <li>
      <a href="../articles/howto-dm-theory.html">Introduction to relational data models</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Technical articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/tech-dm-join.html">Joining in relational data models</a>
    </li>
    <li>
      <a href="../articles/tech-dm-zoom.html">Zooming and manipulating tables</a>
    </li>
    <li>
      <a href="../articles/tech-dm-filter.html">Filtering in relational data models</a>
    </li>
    <li>
      <a href="../articles/tech-dm-draw.html">Visualizing dm objects</a>
    </li>
    <li>
      <a href="../articles/tech-dm-low-level.html">Model verification - keys, constraints and normalization</a>
    </li>
    <li>
      <a href="../articles/tech-dm-class.html">Class 'dm' and basic operations</a>
    </li>
    <li>
      <a href="../articles/tech-dm-naming.html">Function naming logic</a>
    </li>
    <li>
      <a href="../articles/tech-dm-cdm.html">Migration guide: 'cdm' -&gt; 'dm'</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/krlmlr/dm">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="howto-dm-db_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Create a dm object from a database</h1>
                        <h4 class="author">James Wondrasek, Kirill Müller</h4>
            
            <h4 class="date">2020-08-26</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/krlmlr/dm/blob/master/vignettes/howto-dm-db.Rmd"><code>vignettes/howto-dm-db.Rmd</code></a></small>
      <div class="hidden name"><code>howto-dm-db.Rmd</code></div>

    </div>

    
    
<div id="working-with-databases" class="section level1">
<h1 class="hasAnchor">
<a href="#working-with-databases" class="anchor"></a>Working with databases</h1>
<p>A dm object can be created from any database that has a {<a href="https://dbi.r-dbi.org/">DBI</a>} backend (<a href="https://github.com/r-dbi/backends">see list</a>).</p>
<p>When a dm object is created it can either import all the tables in the database, the active schema or a limited set. For some RDBMS, such as Postgres and SQL Server, primary and foreign keys are also imported and do not have to be manually added afterwards.</p>
<p>There is a <a href="https://relational.fit.cvut.cz/dataset/Financial">financial dataset</a> that contains loan data along with relevant account information and transactions. We chose this dataset because the relationships between <code>loan</code>, <code>account</code>, <code>transactions</code> tables are a good representation of databases that record real-world business transactions. The repository uses a MariaDB server for which {dm} does not currently import primary or foreign keys, so we will need to add them.</p>
<p>The dataset is available on database server that is publicly accessible without registration. Connection details will vary for your database, see <code><a href="https://dbi.r-dbi.org/articles/DBI.html">vignette("DBI", package = "DBI")</a></code> for further information.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://rmariadb.r-dbi.org">RMariaDB</a></span>)
<span class="kw">my_db</span> <span class="op">&lt;-</span> <span class="fu">dbConnect</span>(
  <span class="fu"><a href="https://rmariadb.r-dbi.org/reference/dbConnect-MariaDBDriver-method.html">MariaDB</a></span>(),
  username = <span class="st">"guest"</span>,
  password = <span class="st">"relational"</span>,
  dbname = <span class="st">"Financial_ijs"</span>,
  host = <span class="st">"relational.fit.cvut.cz"</span>
)
<span class="co">#&gt; Error: Failed to connect: Lost connection to MySQL server at 'handshake: reading initial communication packet', system error: 60</span>
</pre></div>
<p>Creating a dm object takes a single call to <code><a href="../reference/dm_from_src.html">dm_from_src()</a></code> with the DBI connection object as its argument.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://krlmlr.github.io/dm">dm</a></span>)

<span class="kw">my_dm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dm_from_src.html">dm_from_src</a></span>(<span class="kw">my_db</span>)
<span class="co">#&gt; Error in dm_from_src(my_db): object 'my_db' not found</span>
<span class="kw">my_dm</span>
<span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm' not found</span>
</pre></div>
<p>The components of the <code>my_dm</code> object are lazy tables powered by {<a href="https://dbplyr.tidyverse.org/">dbplyr</a>}. {dbplyr} translates the {<a href="https://dplyr.tidyverse.org/">dplyr</a>} grammar of data manipulation into queries the database server understands. Lazy tables defer downloading of table data until results are required for printing or local processing.</p>
<div id="building-a-dm-from-a-subset-of-tables" class="section level2">
<h2 class="hasAnchor">
<a href="#building-a-dm-from-a-subset-of-tables" class="anchor"></a>Building a dm from a subset of tables</h2>
<p>A dm can also be constructed from individual tables or views. This is useful for when you want to work with a subset of a database’s tables, perhaps from different schemas.</p>
<p>Below we use the <code><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl()</a></code> function from {dplyr} to extract two tables from the financial database. Then we create our dm by passing the tables in as arguments. Note that the tables arguments have to all be from the same source.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="fu">dbListTables</span>(<span class="kw">my_db</span>)
<span class="co">#&gt; Error in h(simpleError(msg, call)): error in evaluating the argument 'conn' in selecting a method for function 'dbListTables': object 'my_db' not found</span>

<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://dbplyr.tidyverse.org">dbplyr</a></span>)
<span class="kw">loans</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span>(<span class="kw">my_db</span>, <span class="st">"loans"</span>)
<span class="co">#&gt; Error in tbl(my_db, "loans"): object 'my_db' not found</span>
<span class="kw">accounts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span>(<span class="kw">my_db</span>, <span class="st">"accounts"</span>)
<span class="co">#&gt; Error in tbl(my_db, "accounts"): object 'my_db' not found</span>

<span class="kw">my_manual_dm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dm.html">dm</a></span>(<span class="kw">loans</span>, <span class="kw">accounts</span>)
<span class="co">#&gt; Error in .f(.x[[i]], ...): object 'loans' not found</span>
<span class="kw">my_manual_dm</span>
<span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_manual_dm' not found</span>
</pre></div>
</div>
<div id="define-primary-and-foreign-keys" class="section level2">
<h2 class="hasAnchor">
<a href="#define-primary-and-foreign-keys" class="anchor"></a>Define Primary and Foreign Keys</h2>
<p>Primary keys and foreign keys are how relational database tables are linked with each other. A primary key is a column that has a unique value for each row within a table. A foreign key is a column containing the primary key for a row in another table.<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> Foreign keys act as cross references between tables. They specify the relationships that gives us the <em>relational</em> database. For more information on keys and a crash course on databases, see <code><a href="../articles/howto-dm-theory.html">vignette("howto-dm-theory")</a></code>.</p>
<p>The <a href="https://relational.fit.cvut.cz/assets/img/datasets-generated/financial.svg">model diagram</a> provided by our test database loosely illustrates the intended relationships between tables. In the diagram we can see that the <code>loans</code> table should be linked to the <code>accounts</code> table. Below we create those links in 3 steps:</p>
<ol style="list-style-type: decimal">
<li>Add a primary key <code>id</code> to the <code>accounts</code> table</li>
<li>Add a primary key <code>id</code> to the <code>loans</code> table</li>
<li>Add a foreign key <code>account_id</code> to the <code>loans</code> table referencing the <code>accounts</code> table</li>
</ol>
<p>Then we assign colors to the tables and draw the structure of the dm.</p>
<p>Note that when the foreign key is created the primary key in the referenced table does not need to be specified, but the primary key must already be defined. And, as mentioned above, primary and foreign key constraints on the database are currently only imported for Postgres and SQL Server databases, and only when <code><a href="../reference/dm_from_src.html">dm_from_src()</a></code> is used. This process of key definition needs to be done manually for other databases.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="kw">my_dm_keys</span> <span class="op">&lt;-</span>
  <span class="kw">my_manual_dm</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_add_pk.html">dm_add_pk</a></span>(<span class="kw">accounts</span>, <span class="kw">id</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_add_pk.html">dm_add_pk</a></span>(<span class="kw">loans</span>, <span class="kw">id</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_add_fk.html">dm_add_fk</a></span>(<span class="kw">loans</span>, <span class="kw">account_id</span>, <span class="kw">accounts</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_draw.html">dm_set_colors</a></span>(green = <span class="kw">loans</span>, orange = <span class="kw">accounts</span>)
<span class="co">#&gt; Error in eval(lhs, parent, parent): object 'my_manual_dm' not found</span>

<span class="kw">my_dm_keys</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_draw.html">dm_draw</a></span>()
<span class="co">#&gt; Error in eval(lhs, parent, parent): object 'my_dm_keys' not found</span>
</pre></div>
<p>Once you have instantiated a dm object you can continue to add tables to it. For tables from the original source for the dm, use <code><a href="../reference/dm_add_tbl.html">dm_add_tbl()</a></code></p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="kw">trans</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/tbl.html">tbl</a></span>(<span class="kw">my_db</span>, <span class="st">"trans"</span>)
<span class="co">#&gt; Error in tbl(my_db, "trans"): object 'my_db' not found</span>

<span class="kw">my_dm_keys</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_add_tbl.html">dm_add_tbl</a></span>(<span class="kw">trans</span>)
<span class="co">#&gt; Error in eval(lhs, parent, parent): object 'my_dm_keys' not found</span>
</pre></div>
<p>For tables from other sources or from the local environment <code><a href="https://dplyr.tidyverse.org/reference/copy_to.html">dplyr::copy_to()</a></code> is used. <code><a href="https://dplyr.tidyverse.org/reference/copy_to.html">copy_to()</a></code> is discussed later in this article.</p>
</div>
<div id="transient-nature-of-operations" class="section level2">
<h2 class="hasAnchor">
<a href="#transient-nature-of-operations" class="anchor"></a>Transient nature of operations</h2>
<p>Like other R objects, a dm is immutable and all operations performed on it are transient unless stored in a new variable.</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="kw">my_dm_keys</span>
<span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_keys' not found</span>

<span class="kw">my_dm_trans</span> <span class="op">&lt;-</span>
  <span class="kw">my_dm_keys</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_add_tbl.html">dm_add_tbl</a></span>(<span class="kw">trans</span>)
<span class="co">#&gt; Error in eval(lhs, parent, parent): object 'my_dm_keys' not found</span>

<span class="kw">my_dm_trans</span>
<span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_trans' not found</span>
</pre></div>
<p>And, like {dbplyr}, results are never written to a database unless explicitly requested.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="kw">my_dm_keys</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_flatten_to_tbl.html">dm_flatten_to_tbl</a></span>(<span class="kw">loans</span>)
<span class="co">#&gt; Error in eval(lhs, parent, parent): object 'my_dm_keys' not found</span>

<span class="kw">my_dm_keys</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_flatten_to_tbl.html">dm_flatten_to_tbl</a></span>(<span class="kw">loans</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dbplyr.tidyverse.org/reference/sql_build.html">sql_render</a></span>()
<span class="co">#&gt; Error in eval(lhs, parent, parent): object 'my_dm_keys' not found</span>
</pre></div>
</div>
<div id="performing-operations-on-tables-by-zooming" class="section level2">
<h2 class="hasAnchor">
<a href="#performing-operations-on-tables-by-zooming" class="anchor"></a>Performing operations on tables by “zooming”</h2>
<p>As the dm is a collection of tables, if we wish to perform operations on an individual table we set it as the context for those operations using <code><a href="../reference/dm_zoom_to.html">dm_zoom_to()</a></code>. See <code><a href="../articles/tech-dm-zoom.html">vignette("tech-dm-zoom")</a></code> for more detail on zooming.</p>
<p>dm operations are transient unless persistence is explicitly requested. To make our chain of manipulations on the selected table permanent we assign the result of <code><a href="../reference/dm_zoom_to.html">dm_insert_zoomed()</a></code> to a new object, <code>my_dm_total</code>. This is a new dm object, derived from <code>my_dm_keys</code>, with a new lazy table <code>total_loans</code> linked to the <code>accounts</code> table. The subsequent section describes how to materialize the results on the database.</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="kw">my_dm_total</span> <span class="op">&lt;-</span>
  <span class="kw">my_dm_keys</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_zoom_to.html">dm_zoom_to</a></span>(<span class="kw">loans</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="kw">account_id</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span>(total_amount = <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw">amount</span>, na.rm = <span class="fl">TRUE</span>)) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span>() <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_zoom_to.html">dm_insert_zoomed</a></span>(<span class="st">"total_loans"</span>)
<span class="co">#&gt; Error in eval(lhs, parent, parent): object 'my_dm_keys' not found</span>

<span class="kw">my_dm_total</span><span class="op">$</span><span class="kw">total_loans</span>
<span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_total' not found</span>

<span class="kw">my_dm_total</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_draw.html">dm_draw</a></span>()
<span class="co">#&gt; Error in eval(lhs, parent, parent): object 'my_dm_total' not found</span>

<span class="kw">my_dm_total</span><span class="op">$</span><span class="kw">total_loans</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dbplyr.tidyverse.org/reference/sql_build.html">sql_render</a></span>()
<span class="co">#&gt; Error in eval(lhs, parent, parent): object 'my_dm_total' not found</span>
</pre></div>
</div>
<div id="persist" class="section level2">
<h2 class="hasAnchor">
<a href="#persist" class="anchor"></a>Persisting results</h2>
<p>After adding columns to link tables or calculate summaries of data, we might want these changes to the database to persist.</p>
<p>To force a dm to execute the SQL query generated by the operations it has performed, we call the <code><a href="https://dplyr.tidyverse.org/reference/compute.html">dplyr::compute()</a></code> method on the dm object.</p>
<p><code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> forces the computation of a query, in this case the query or multiple queries created by the dm to represent all operations that have been performed but not yet evaluated. The results of <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> are stored in temporary tables on the database server and will be deleted when your session ends. If you want results to persist across sessions in permanent tables, <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> must be called with the argument <code>temporary = FALSE</code> and a table name for the <code>name</code> argument. See the <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> documentation for more details.</p>
<p>Calling <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> requires write access, otherwise an error is returned. Our example RDBMS, relational.fit.cvut.cz, does not allow write access. As a workaround to demonstrate the usage of <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code>, we will use <code><a href="../reference/dm_financial.html">dm_financial_sqlite()</a></code>, a convenience function that handles the copying of the dm from the remote RDBMS to a local SQLite database we can write to.</p>
<div class="sourceCode" id="cb9"><pre class="downlit">
<span class="kw">my_dm_sqlite</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dm_financial.html">dm_financial_sqlite</a></span>()
<span class="co">#&gt; Error: Failed to connect: Lost connection to MySQL server at 'handshake: reading initial communication packet', system error: 60</span>

<span class="kw">my_dm_total</span> <span class="op">&lt;-</span>
  <span class="kw">my_dm_sqlite</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_zoom_to.html">dm_zoom_to</a></span>(<span class="kw">loans</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="kw">account_id</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span>(total_amount = <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw">amount</span>, na.rm = <span class="fl">TRUE</span>)) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span>() <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_zoom_to.html">dm_insert_zoomed</a></span>(<span class="st">"total_loans"</span>)
<span class="co">#&gt; Error in eval(lhs, parent, parent): object 'my_dm_sqlite' not found</span>
</pre></div>
<p>Two {<a href="https://dplyr.tidyverse.org/">dplyr</a>} verbs have been implemented for dm objects. <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code>, as mentioned above, materializes all tables into new (temporary or persistent) tables.</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="kw">my_dm_total_computed</span> <span class="op">&lt;-</span>
  <span class="kw">my_dm_total</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">compute</a></span>()
<span class="co">#&gt; Error in eval(lhs, parent, parent): object 'my_dm_total' not found</span>

<span class="kw">my_dm_total_computed</span><span class="op">$</span><span class="kw">total_loans</span>
<span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_total_computed' not found</span>

<span class="kw">my_dm_total_computed</span><span class="op">$</span><span class="kw">total_loans</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dbplyr.tidyverse.org/reference/sql_build.html">sql_render</a></span>()
<span class="co">#&gt; Error in eval(lhs, parent, parent): object 'my_dm_total_computed' not found</span>
</pre></div>
<p><code><a href="https://dplyr.tidyverse.org/reference/compute.html">collect()</a></code> downloads all tables to local data frames.</p>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="kw">my_dm_local</span> <span class="op">&lt;-</span>
  <span class="kw">my_dm_total</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collect</a></span>()
<span class="co">#&gt; Error in eval(lhs, parent, parent): object 'my_dm_total' not found</span>

<span class="kw">my_dm_local</span><span class="op">$</span><span class="kw">total_loans</span>
<span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_local' not found</span>
</pre></div>
<p>There is a third {dbplyr} verb that has not yet been implemented. <code>collapse()</code> forces generation of the SQL query instead of computation (<a href="https://github.com/krlmlr/dm/issues/304">#304</a>).</p>
<p><code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> also works for a zoomed dm. Calling it during a chain of operations will execute all relevant SQL queries up to that point. Operations after the <code><a href="https://dplyr.tidyverse.org/reference/compute.html">compute()</a></code> will use the generated results.</p>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="kw">my_dm_total_inplace</span> <span class="op">&lt;-</span>
  <span class="kw">my_dm_sqlite</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_zoom_to.html">dm_zoom_to</a></span>(<span class="kw">loans</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span>(<span class="kw">account_id</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarize</a></span>(total_amount = <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="kw">amount</span>, na.rm = <span class="fl">TRUE</span>)) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span>() <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">compute</a></span>() <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_zoom_to.html">dm_insert_zoomed</a></span>(<span class="st">"total_loans"</span>)
<span class="co">#&gt; Error in eval(lhs, parent, parent): object 'my_dm_sqlite' not found</span>

<span class="kw">my_dm_total_inplace</span><span class="op">$</span><span class="kw">total_loans</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dbplyr.tidyverse.org/reference/sql_build.html">sql_render</a></span>()
<span class="co">#&gt; Error in eval(lhs, parent, parent): object 'my_dm_total_inplace' not found</span>
</pre></div>
</div>
<div id="deploying-a-dm-to-a-database" class="section level2">
<h2 class="hasAnchor">
<a href="#deploying-a-dm-to-a-database" class="anchor"></a>Deploying a dm to a database</h2>
<p>To deploy a dm we must copy it to a RDBMS. This is done using the method <code><a href="../reference/copy_dm_to.html">copy_dm_to()</a></code>, which is used behind the scenes by our <code><a href="../reference/dm_financial.html">dm_financial_sqlite()</a></code> function, the code for which appears below.</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="kw">dm_financial_sqlite</span>
<span class="co">#&gt; Memoised Function:</span>
<span class="co">#&gt; function () </span>
<span class="co">#&gt; {</span>
<span class="co">#&gt;     stopifnot(rlang::is_installed("RSQLite"))</span>
<span class="co">#&gt;     my_dm &lt;- dm_financial() %&gt;% dm_select_tbl(-trans)</span>
<span class="co">#&gt;     sqlite_db &lt;- DBI::dbConnect(RSQLite::SQLite())</span>
<span class="co">#&gt;     sqlite_dm &lt;- copy_dm_to(sqlite_db, my_dm, temporary = FALSE)</span>
<span class="co">#&gt;     sqlite_dm</span>
<span class="co">#&gt; }</span>
<span class="co">#&gt; &lt;bytecode: 0x7fe2a0c19848&gt;</span>
<span class="co">#&gt; &lt;environment: namespace:dm&gt;</span>
</pre></div>
<p>As demonstrated, <code><a href="../reference/copy_dm_to.html">copy_dm_to()</a></code> takes as arguments a {DBI} connection that is the destination, the dm we wish to deploy, and here the <code>temporary</code> argument set to FALSE as this is a deployment and we want it to be permanent. The dm is copied to the DBI connection and a new dm, with the DBI connection as its source, is returned.</p>
<p>The default behavior is to create temporary tables and, where possible (currently Postgres and SQL server), to set any key constraints.</p>
</div>
<div id="adding-local-data-frames-to-an-rdbms" class="section level2">
<h2 class="hasAnchor">
<a href="#adding-local-data-frames-to-an-rdbms" class="anchor"></a>Adding local data frames to an RDBMS</h2>
<p>If you need to add local data frames to an existing database, the shortest path is to use <code><a href="https://dplyr.tidyverse.org/reference/copy_to.html">copy_to()</a></code>. It takes the same arguments as <code><a href="../reference/copy_dm_to.html">copy_dm_to()</a></code>, except the second argument, instead of expecting a dm, expects a data frame.</p>
<p>The example below estimates a linear model from attributes in the <code>loans</code> and <code>districts</code> tables, inserts residuals into the database, and links them to the <code>loans</code> table.</p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="kw">loans_df</span> <span class="op">&lt;-</span>
  <span class="kw">my_dm_sqlite</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_flatten_to_tbl.html">dm_squash_to_tbl</a></span>(<span class="kw">loans</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="kw">id</span>, <span class="kw">amount</span>, <span class="kw">duration</span>, <span class="kw">A3</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/compute.html">collect</a></span>()
<span class="co">#&gt; Error in eval(lhs, parent, parent): object 'my_dm_sqlite' not found</span>

<span class="kw">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span>(<span class="kw">amount</span> <span class="op">~</span> <span class="kw">duration</span> <span class="op">+</span> <span class="kw">A3</span>, data = <span class="kw">loans_df</span>)
<span class="co">#&gt; Error in is.data.frame(data): object 'loans_df' not found</span>

<span class="kw">loans_residuals</span> <span class="op">&lt;-</span> <span class="kw">tibble</span>::<span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span>(
  id = <span class="kw">loans_df</span><span class="op">$</span><span class="kw">id</span>,
  resid = <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/residuals.html">residuals</a></span>(<span class="kw">model</span>))
)
<span class="co">#&gt; Error in eval_tidy(xs[[j]], mask): object 'loans_df' not found</span>

<span class="kw">my_dm_sqlite_resid</span> <span class="op">&lt;-</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/copy_to.html">copy_to</a></span>(<span class="kw">my_dm_sqlite</span>, <span class="kw">loans_residuals</span>, temporary = <span class="fl">FALSE</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_add_pk.html">dm_add_pk</a></span>(<span class="kw">loans_residuals</span>, <span class="kw">id</span>) <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_add_fk.html">dm_add_fk</a></span>(<span class="kw">loans_residuals</span>, <span class="kw">id</span>, <span class="kw">loans</span>)
<span class="co">#&gt; Error in copy_to(my_dm_sqlite, loans_residuals, temporary = FALSE): object 'my_dm_sqlite' not found</span>

<span class="kw">my_dm_sqlite_resid</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_draw.html">dm_draw</a></span>()
<span class="co">#&gt; Error in eval(lhs, parent, parent): object 'my_dm_sqlite_resid' not found</span>
<span class="kw">my_dm_sqlite_resid</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/dm_examine_constraints.html">dm_examine_constraints</a></span>()
<span class="co">#&gt; Error in eval(lhs, parent, parent): object 'my_dm_sqlite_resid' not found</span>
<span class="kw">my_dm_sqlite_resid</span><span class="op">$</span><span class="kw">loans_residuals</span>
<span class="co">#&gt; Error in eval(expr, envir, enclos): object 'my_dm_sqlite_resid' not found</span>
</pre></div>
</div>
<div id="conclusion" class="section level2">
<h2 class="hasAnchor">
<a href="#conclusion" class="anchor"></a>Conclusion</h2>
<p>In this tutorial we have demonstrated how to use {dm} to work with existing databases and to construct your own from local tables, including specifying key constraints, and then deploy them to a RDBMS. If you would like more details an overview of all the methods available in {dm}, please see the <a href="https://krlmlr.github.io/dm/reference/index.html">reference documentation</a>.</p>
</div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p>Support for compound keys (consisting of multiple columns) is <a href="https://github.com/krlmlr/dm/issues/3">planned</a>.<a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Tobias Schieferdecker, <a href="http://krlmlr.info">Kirill Müller</a>, Darko Bergant, <a href="https://www.energie360.ch"><img src="https://krlmlr.github.io/dm/reference/figures/energie-72.png" height="16"></a>, <a href="https://www.cynkra.com"><img src="https://krlmlr.github.io/dm/reference/figures/cynkra-72.png" height="16"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
