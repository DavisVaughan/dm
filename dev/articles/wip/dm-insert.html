<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Updating tables and dm objects • dm</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Updating tables and dm objects">
<meta property="og:description" content="dm">
<meta property="og:image" content="https://krlmlr.github.io/dm/logo.png">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">dm</a>
        <span class="version label label-danger" data-toggle="tooltip" data-placement="bottom" title="In-development version">0.1.7.9001</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../articles/dm.html">Intro</a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/howto-dm-db.html">Create a dm object from a database</a>
    </li>
    <li>
      <a href="../../articles/howto-dm-df.html">Create a dm object from data frames</a>
    </li>
    <li>
      <a href="../../articles/howto-dm-theory.html">Introduction to relational data models</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Technical articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/tech-dm-join.html">Joining in relational data models</a>
    </li>
    <li>
      <a href="../../articles/tech-dm-zoom.html">Zooming and manipulating tables</a>
    </li>
    <li>
      <a href="../../articles/tech-dm-filter.html">Filtering in relational data models</a>
    </li>
    <li>
      <a href="../../articles/tech-dm-draw.html">Visualizing dm objects</a>
    </li>
    <li>
      <a href="../../articles/tech-dm-low-level.html">Model verification - keys, constraints and normalization</a>
    </li>
    <li>
      <a href="../../articles/tech-dm-class.html">Class 'dm' and basic operations</a>
    </li>
    <li>
      <a href="../../articles/tech-dm-naming.html">Function naming logic</a>
    </li>
    <li>
      <a href="../../articles/tech-dm-cdm.html">Migration guide: 'cdm' -&gt; 'dm'</a>
    </li>
  </ul>
</li>
<li>
  <a href="../../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/krlmlr/dm">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="dm-insert_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="dm-insert_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="dm-insert_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Updating tables and dm objects</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/krlmlr/dm/blob/master/vignettes/wip/dm-insert.Rmd"><code>vignettes/wip/dm-insert.Rmd</code></a></small>
      <div class="hidden name"><code>dm-insert.Rmd</code></div>

    </div>

    
    
<p>This draft describes update operations on tables and dm objects. The generics for the table operations can be private in dm for now and move to dplyr later. Contains parts from <a href="https://github.com/tidyverse/dplyr/issues/4654" class="uri">https://github.com/tidyverse/dplyr/issues/4654</a>.</p>
<div id="tables" class="section level2">
<h2 class="hasAnchor">
<a href="#tables" class="anchor"></a>Tables</h2>
<p>In dplyr, operations on tables in dplyr are generally transient or ephemeral. Resulting table objects must be stored in a new object, otherwise they are lost. All operations by default return a new table object that is disconnected from the original.</p>
<div id="operations" class="section level3">
<h3 class="hasAnchor">
<a href="#operations" class="anchor"></a>Operations</h3>
<p>The operations are modeled after existing database statements, with the exception of the new “patch”.</p>
<ul>
<li><p>insert new rows — would error if keys already exist, similar to <code><a href="https://tibble.tidyverse.org/reference/add_row.html">tibble::add_row()</a></code>.</p></li>
<li><p>update values — overrides existing values. (Similar to <a href="https://github.com/tidyverse/tidyr/issues/183" class="uri">https://github.com/tidyverse/tidyr/issues/183</a>)</p></li>
<li><p>patch values — like update, but only replaces missing values (Also similar to <a href="https://github.com/tidyverse/tidyr/issues/183" class="uri">https://github.com/tidyverse/tidyr/issues/183</a>)</p></li>
<li><p>upsert — update or insert depending on presence/absence of keys</p></li>
</ul>
<p>All operations would either take multiple named inputs or a single unnamed data frame. Additional restrictions and options may apply on other backends, these will be specified with arguments that start with a dot. For extensibility, named inputs that start with a dot are silently discarded.</p>
<p>All operations require specification of a <code>.key</code> argument. Unlike <code>by</code> with joins, the <code>.key</code> argument is mandatory, because RHS column names must be a subset of the LHS column names. Keys must have the same name in the target and the input. If the table container knows its keys (e.g., grouped data frames or data.table), <code>.key</code> may be omitted.</p>
<p>Both target table and source columns/table must be compatible:</p>
<ul>
<li>Source has no extra tables and columns.</li>
<li>Key columns must be present in source.</li>
</ul>
</div>
<div id="mutable-backends" class="section level3">
<h3 class="hasAnchor">
<a href="#mutable-backends" class="anchor"></a>Mutable backends</h3>
<p>Some <em>mutable</em> backends, most notably databases, Google sheets and data.table, permit in-place update of the source data. Update operations on mutable backends should optionally allow updating the source data. Because this is a potentially destructive exception from the dplyr guarantees, in-place updates must be “opt in”. The default result always will be a “lazy” table. This allows previewing the results of an update operation before materializing.</p>
<p>On these backends, the following additional operations are useful:</p>
<ul>
<li><p>delete — remove rows that match keys, a variant of <code><a href="https://dplyr.tidyverse.org/reference/filter-joins.html">anti_join()</a></code></p></li>
<li><p>truncate — remove all rows</p></li>
</ul>
<p>Databases will require that the data is already on the database or ask the user to supply a <code>copy</code> argument.</p>
<p>On mutable backends, update operations return the input, invisibly, if the update was carried out in-place.</p>
<p>Challenges:</p>
<ul>
<li>How to make compatible with <code><a href="https://dbplyr.tidyverse.org/reference/sql_build.html">sql_render()</a></code>?</li>
</ul>
</div>
</div>
<div id="dm" class="section level2">
<h2 class="hasAnchor">
<a href="#dm" class="anchor"></a>dm</h2>
<p>Operations on a dm object are generally transient or ephemeral. Resulting dm or table objects must be stored in a new object, otherwise they are lost.</p>
<div id="design" class="section level3">
<h3 class="hasAnchor">
<a href="#design" class="anchor"></a>Design</h3>
<ul>
<li>records from tables from a source dm are appended/updated/upserted/removed/replaced/… from the target dm</li>
<li>both dm must be compatible
<ul>
<li>same source</li>
<li>source is a subset of target tables</li>
</ul>
</li>
<li>dry run supported: use transient operations instead of materialization
<ul>
<li>check integrity constraints are still valid after running</li>
<li>compare before-after state</li>
</ul>
</li>
<li>transactions out of scope, caller can use <code>DBI::withTransaction()</code>
</li>
<li>some operations need top-down, others need bottom-up
<ul>
<li>fixed set of operations, each op knows its “direction”</li>
</ul>
</li>
</ul>
</div>
<div id="logic-of-operation" class="section level3">
<h3 class="hasAnchor">
<a href="#logic-of-operation" class="anchor"></a>Logic of operation</h3>
<ul>
<li>check compatibility</li>
<li>persist tables one by one, topologically sorted</li>
<li>put back into dm if necessary</li>
</ul>
</div>
<div id="api-draft" class="section level3">
<h3 class="hasAnchor">
<a href="#api-draft" class="anchor"></a>API draft</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dm_insert</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, <span class="va">...</span>, <span class="va">dry_run</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">check_dots_empty</span><span class="op">(</span><span class="op">)</span>

  <span class="fu">dm_persist</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, operation <span class="op">=</span> <span class="va">tbl_insert</span>, top_down <span class="op">=</span> <span class="cn">TRUE</span>, dry_run <span class="op">=</span> <span class="va">dry_run</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">dm_update</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, <span class="va">...</span>, <span class="va">dry_run</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">check_dots_empty</span><span class="op">(</span><span class="op">)</span>

  <span class="fu">dm_persist</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, operation <span class="op">=</span> <span class="va">tbl_update</span>, top_down <span class="op">=</span> <span class="cn">TRUE</span>, dry_run <span class="op">=</span> <span class="va">dry_run</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">dm_upsert</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, <span class="va">...</span>, <span class="va">dry_run</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">check_dots_empty</span><span class="op">(</span><span class="op">)</span>

  <span class="fu">dm_persist</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, operation <span class="op">=</span> <span class="va">tbl_upsert</span>, top_down <span class="op">=</span> <span class="cn">TRUE</span>, dry_run <span class="op">=</span> <span class="va">dry_run</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">dm_delete</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, <span class="va">...</span>, <span class="va">dry_run</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">check_dots_empty</span><span class="op">(</span><span class="op">)</span>

  <span class="fu">dm_persist</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, operation <span class="op">=</span> <span class="va">tbl_delete</span>, top_down <span class="op">=</span> <span class="cn">FALSE</span>, dry_run <span class="op">=</span> <span class="va">dry_run</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">dm_truncate</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, <span class="va">...</span>, <span class="va">dry_run</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">check_dots_empty</span><span class="op">(</span><span class="op">)</span>

  <span class="fu">dm_persist</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, operation <span class="op">=</span> <span class="va">tbl_truncate</span>, top_down <span class="op">=</span> <span class="cn">FALSE</span>, dry_run <span class="op">=</span> <span class="va">dry_run</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">dm_persist</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, <span class="va">operation</span>, <span class="va">top_down</span>, <span class="va">dry_run</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">dm_check_persist</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span><span class="op">)</span>

  <span class="fu">dm_run_persist</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, <span class="va">operation</span>, <span class="va">top_down</span>, <span class="va">dry_run</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">dm_check_persist</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">check_not_zoomed</span><span class="op">(</span><span class="va">target_dm</span><span class="op">)</span>
  <span class="fu">check_not_zoomed</span><span class="op">(</span><span class="va">dm</span><span class="op">)</span>

  <span class="fu">check_same_src</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span><span class="op">)</span>
  <span class="fu">walk2</span><span class="op">(</span><span class="fu"><a href="../../reference/dm.html">dm_get_tables</a></span><span class="op">(</span><span class="va">target_dm</span><span class="op">)</span>, <span class="fu"><a href="../../reference/dm.html">dm_get_tables</a></span><span class="op">(</span><span class="va">dm</span><span class="op">)</span>, <span class="va">check_columns_superset</span><span class="op">)</span>
  <span class="fu">check_keys_compatible</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">dm_run_persist</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">target_dm</span>, <span class="va">dm</span>, <span class="va">operation</span>, <span class="va">top_down</span>, <span class="va">dry_run</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># topologically sort tables</span>
  <span class="co"># run operation(target_tbl, source_tbl, dry_run = dry_run) for each table</span>
  <span class="co"># operation() always returns tbl, only need to patch if not the same tbl</span>
  <span class="co"># new_tables is list of non-NULL operation() values</span>

  <span class="va">target_dm</span> <span class="op">%&gt;%</span>
    <span class="fu">dm_patch_tbl</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">new_tables</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">dm_patch_tbl</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dm</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">check_not_zoomed</span><span class="op">(</span><span class="va">dm</span><span class="op">)</span>

  <span class="va">new_tables</span> <span class="op">&lt;-</span> <span class="fu">list2</span><span class="op">(</span><span class="va">...</span><span class="op">)</span>

  <span class="co"># FIXME: Better error message for unknown tables</span>

  <span class="va">def</span> <span class="op">&lt;-</span> <span class="fu">dm_get_def</span><span class="op">(</span><span class="va">dm</span><span class="op">)</span>
  <span class="va">idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">new_tables</span><span class="op">)</span>, <span class="va">def</span><span class="op">$</span><span class="va">table</span><span class="op">)</span>
  <span class="va">def</span><span class="op">[</span><span class="va">idx</span>, <span class="st">"data"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="va">new_tables</span><span class="op">)</span>
  <span class="fu">new_dm3</span><span class="op">(</span><span class="va">def</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Tobias Schieferdecker, <a href="http://krlmlr.info">Kirill Müller</a>, Darko Bergant, <a href="https://www.energie360.ch"><img src="https://krlmlr.github.io/dm/reference/figures/energie-72.png" height="16"></a>, <a href="https://www.cynkra.com"><img src="https://krlmlr.github.io/dm/reference/figures/cynkra-72.png" height="16"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
