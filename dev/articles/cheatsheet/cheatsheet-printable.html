<!DOCTYPE html><head>  <script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script>  <title>dm cheat sheet</title>  <meta http-equiv="Content-Type"      content="text/html; charset=utf-8">  <meta    name="viewport"    content="width=device-width, initial-scale=1, shrink-to-fit=no"  />  <link    rel="stylesheet"    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"    integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g=="    crossorigin="anonymous"    referrerpolicy="no-referrer"  />  <script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<link href="deps/bootstrap-5.1.3/bootstrap.min.css" rel="stylesheet" />
<script src="deps/bootstrap-5.1.3/bootstrap.bundle.min.js"></script>
<script src="deps/bs3compat-0.4.1/transition.js"></script>
<script src="deps/bs3compat-0.4.1/tabs.js"></script>
<script src="deps/bs3compat-0.4.1/bs3compat.js"></script>  <link href="cheatsheet.css" rel="stylesheet" />  <script src="https://unpkg.com/pagedjs/dist/paged.polyfill.js"></script></head><body>  <div class="container">    <div class="page page1">      <div class="page-header">        <h1>          Relational data with dm: Cheat sheet <br /><small            >If you have more than one table, use dm.</small          >          <img src="logo.svg" class="logo" />        </h1>      </div>      <div class="row align-items-start">        <div class="col col-md-4">        

<h2>
<i class="fa-solid fa-circle-plus"></i> Create dm…</h2>


<h3 id="from-database-dm_from_con">
<i class="fa-solid fa-database"></i>
from database: <code>dm_from_con()</code>
</h3>


<pre><code>&lt;figure class="right"&gt;
  &lt;img alt="cheatsheet-figures/dm_from_con.svg" src="diagram showing the transformation from left a database icon to right a dm object represented as three tables in a blue frame"/&gt;
  &lt;figcaption&gt;&lt;pre&gt;&lt;code class="language-r"&gt;con &amp;lt;- DBI::dbConnect(...)</code></pre>

dm_from_con(con) 



<pre><code>&lt;/figure&gt;</code></pre>


<h3 id="from-data-frames-dmdf1-df2-...">
<i class="fa-solid fa-table"></i>
from data frames: <code>dm(df1, df2, ...)</code>
</h3>


<pre><code>&lt;figure class="right"&gt;
  &lt;img alt="cheatsheet-figures/dm.svg" src="diagram showing the transformation from left three data frames to right a dm object represented as three tables in a blue frame"/&gt;
  &lt;figcaption&gt;&lt;pre&gt;&lt;code class="language-r"&gt;dm(df1, df2, df3)</code></pre>





<pre><code>&lt;/figure&gt;</code></pre>


<h3 id="from-dm-dmdm1-df1...">
<i class="fa-solid fa-diagram-project"></i>
from dm: <code>dm(dm1, df1...)</code>
</h3>


<pre><code>&lt;figure class="right"&gt;
  &lt;img alt="cheatsheet-figures/dm-df.svg" src="diagram showing the transformation from left a dm with a data frame below to right a single dm object represented as three tables in a blue frame"/&gt;
  &lt;figcaption&gt;&lt;pre&gt;&lt;code class="language-r"&gt;dm(dm1, df1)</code></pre>





<pre><code>&lt;/figure&gt;



&lt;figure class="right"&gt;
  &lt;img alt="cheatsheet-figures/dm-dm.svg" src="diagram showing the transformation from left two dm objects to right a single dm object represented as three tables in a blue frame"/&gt;
  &lt;figcaption&gt;&lt;pre&gt;&lt;code class="language-r"&gt;dm(dm1, dm2)</code></pre>





<pre><code>&lt;/figure&gt;</code></pre>


<hr class="d-none d-print-block">

<h3 id="add-keys-dm_add_pk-dm_add_fk">Add keys:
<code>dm_add_pk()</code>, <code>dm_add_fk()</code>
</h3>


<p><strong>Automatic</strong> for MariaDB, SQL Server, Postgres, and
others.</p>


<h4 id="primary-keys">
<i class="fa-solid fa-key"></i> Primary keys</h4>


<p><strong>Identify</strong> potential primary keys:</p>


<ul>
<li>
<p><code>dm_enum_pk_candidates()</code>: columns, candidate,
why.</p>
<figure class="right"><p><img alt="cheatsheet-figures/primary-keys.svg" src="left%20a%20single%20dm%20object%20represented%20as%20three%20tables%20in%20a%20blue%20frame,%20right%20the%20same%20but%20with%20markers%20for%20primary%20keys"></p>
<figcaption><p>
</p>
<p><strong>Add</strong> primary keys:</p>

<pre><code class="language-r">dm1 |&gt;
dm_add_pk(table, columns)
</code></pre>
</figcaption></figure>
</li>
</ul>

<p><strong>Identify</strong> potential foreign keys:</p>


<ul>
<li>
<p><code>dm_enum_fk_candidates()</code>: columns, candidate,
why.</p>
<figure class="right"><p><img alt="cheatsheet-figures/fk.svg" src="left%20a%20single%20dm%20object%20represented%20as%20three%20tables%20in%20a%20blue%20frame,%20right%20the%20same%20but%20with%20an%20arrow%20to%20indicate%20a%20foreign%20key%20relationship"></p>
<figcaption><p>
</p>
<p><strong>Add</strong> foreign keys:</p>

<pre><code class="language-r">dm1 |&gt;
dm_add_fk(table, column)
</code></pre>
</figcaption></figure>
</li>
</ul>        </div>        <div class="col col-md-4">         

<div id="dm-objects-relational-data-models" class="important-div">
<h3>
<i class="fa-solid fa-circle-info"></i> dm objects: relational data
models</h3>
<p>The dm package provides a <strong>grammar of relational data
models</strong>. It helps maintain <strong>referential
integrity</strong>.</p>
<p>A dm behaves like a list of tables (data frames or lazy tables)
capturing <strong>relationships</strong> between the tables.</p>
</div>


<div class="alert alert-primary" role="alert" style="display:grid;place-items:center;">
<p><i class="fa-solid fa-arrow-up-right-from-square"></i> Shiny app:
<code>dm_gui(dm = dm1)</code></p>
<p><img alt="Screenshot of the Shiny app provided by dm. It has three parts. On the left is a diagram view of the dm that one can click to, for instance, select tables or change their colors. On the right, there is the generated code as well as a menu to control primary and foreign keys." src="cheatsheet-figures/shiny.png" style="max-width: 75%; margin:auto;"></p>
</div>


<hr class="d-none d-print-block">

<h2 id="resize-dm">
<i class="fa-solid fa-filter"></i> Resize dm</h2>


<h3 id="select-tables-dm_select_tbldm1-...">Select tables:
<code>dm_select_tbl(dm1, ...)</code>
</h3>


<pre><code>&lt;figure class="right"&gt;
  &lt;img alt="cheatsheet-figures/select_tbl.svg" src="diagram showing two dm objects, the one on the right has one table less"/&gt;
  &lt;figcaption&gt;&lt;pre&gt;&lt;code class="language-r"&gt;dm1 |&amp;gt;</code></pre>

dm_select_tbl(-df3) 



<pre><code>&lt;/figure&gt;</code></pre>


<h3 id="rename-tables-dm_rename_tbldm1-...">Rename tables:
<code>dm_rename_tbl(dm1, ...)</code>
</h3>


<h3 id="select-columns-dm_selectdm1-table-...">Select columns:
<code>dm_select(dm1, table, ...)</code>
</h3>


<p>Automatic update of dm meta-information and table relations.</p>


<pre><code>&lt;figure class="right"&gt;
  &lt;img alt="cheatsheet-figures/dm_select.svg" src="diagram showing two dm objects, the third table of the one on the right has two colmns less"/&gt;
  &lt;figcaption&gt;&lt;pre&gt;&lt;code class="language-r"&gt;dm1 |&amp;gt;</code></pre>

dm_select(df3, -c3, -c4) 



<pre><code>&lt;/figure&gt;</code></pre>


<h3 id="rename-columns-dm_renamedm1-table-...">Rename columns:
<code>dm_rename(dm1, table, ...)</code>
</h3>


<h3 id="filter-rows-dm_filterdm1-table-pred">Filter rows:
<code>dm_filter(dm1, table = (pred))</code>
</h3>


<p>Filter rows in the table where the condition is defined, but also all
directly/indirectly connected tables.</p>


<pre><code>&lt;figure class="right"&gt;
  &lt;img alt="cheatsheet-figures/filter.svg" src="diagram showing two dm objects, the one on the right has tables with less rows"/&gt;
  &lt;figcaption&gt;&lt;pre&gt;&lt;code class="language-r"&gt;dm1 |&amp;gt;</code></pre>

dm_filter(df3 = (x == "val")) 



<pre><code>&lt;/figure&gt;</code></pre>

        </div>        <div class="col col-md-4">         

<h2 id="visualize-dm-dm_draw">
<i class="fa-solid fa-eye"></i> Visualize
dm: <code>dm_draw()</code>
</h2>


<h3 id="control-diagram-level-of-detail-display">Control diagram level
of detail: display…</h3>


<ul>
<li><p>Only keys (default):
<code>dm_draw(view_type = "keys_only")</code>.</p></li>
<li><p>All variables: <code>dm_draw(view_type = "all")</code>.</p></li>
<li>
<p>Only table names:
<code>dm_draw(view_type = "title_only")</code>.</p>
<figure class="right"><p><img alt="cheatsheet-figures/draw-title_only.svg" src="Diagram%20with%20linked%20rectangles%20(tables).%20Only%20table%20names."></p>
<figcaption><pre><code class="language-r">dm |&gt;
dm_draw(
  view_type = "title_only",
  rankdir = "TB"
)
</code></pre>
</figcaption></figure>
</li>
</ul>

<h3 id="control-diagram-scope">Control diagram scope</h3>


<p>To visualize fewer tables first use <code>dm_select_tbl()</code>.</p>


<h3 id="control-diagram-colors-dm_set_colors">Control diagram colors:
<code>dm_set_colors()</code>
</h3>


<pre><code>&lt;figure class="right"&gt;
  &lt;img alt="cheatsheet-figures/df-pk-fk-col.svg" src="Diagram with linked rectangles (tables). The flight table is pink, the airlines and airpots tables whose name start with 'air', are orange."/&gt;
  &lt;figcaption&gt;&lt;pre&gt;&lt;code class="language-r"&gt;dm |&amp;gt;</code></pre>

dm_set_colors( pink = flights, orange = starts_with("air") ) |&gt;
dm_draw() 



<pre><code>&lt;/figure&gt;</code></pre>


<hr class="d-none d-print-block">

<h2 id="data-checks">
<i class="fa-solid fa-check"></i> Data checks</h2>


<h3 id="dm_examine_constraints"><code>dm_examine_constraints()</code></h3>


<p>tibble with information about which key constraints are met or
violated.</p>


<h3 id="dm_examine_cardinalities"><code>dm_examine_cardinalities()</code></h3>


<p>tibble with information about the cardinality of the foreign keys
constraints.</p>


<h3 id="check_keydf-col1"><code>check_key(df, col1)</code></h3>


<p>returns an error if not an unique key.</p>


<h3 id="check_subsetdf1-df2"><code>check_subset(df1, df2)</code></h3>


<p>returns an error if <code>df1</code> is not a subset of
<code>df2</code>.</p>


<h3 id="check_set_equalitydf1-df2"><code>check_set_equality(df1, df2)</code></h3>


<p>returns an error if <code>df1</code> and <code>df2</code> are not the
same sets.</p>


<hr class="d-none d-print-block">

<h3 id="fix-column-names-dm_disambiguate_cols">
<i class="fa-solid fa-tags"></i>
Fix column names: <code>dm_disambiguate_cols()</code>
</h3>


<p><code>dm_disambiguate_cols(dm1)</code> ensures that all columns in a
dm have unique names.</p>

        </div>      </div>    </div>    <div class="page">      <div class="page-header">        <h1>Relational data with dm: Cheat sheet<br /><small            >If you have more than one table, use dm.</small          >          <img src="cheatsheet/logo.svg" class="logo" />        </h1>      </div>      <div class="row align-items-start">        <div class="col col-md-4">        

<h2>
<i class="fa-solid fa-table"></i> Transform dm into tibble</h2>


<h3 id="wide-tibble-cascade-joins-with-dm_flatten_to_tbl">Wide tibble:
Cascade joins with <code>dm_flatten_to_tbl()</code>
</h3>


<p>Only direct neighbours: <code>dm_flatten_to_tbl()</code></p>


<pre><code>&lt;figure class="big"&gt;
  &lt;img alt="cheatsheet-figures/flatten.svg" src="On the left a dm object where table A is linked to table B and table C. Table D is linked to table B. On the right a table corresponding to a join of table A, B and C. Not D as it is not a direct neighboor"/&gt;
  &lt;figcaption&gt;&lt;pre&gt;&lt;code class="language-r"&gt;dm1 |&amp;gt;</code></pre>

dm_flatten_to_tbl( .start = df1 ) 



<pre><code>&lt;/figure&gt;</code></pre>


<p>All neighbours: <code>dm_flatten_to_tbl(.recursive = TRUE)</code></p>


<pre><code>&lt;figure class="big"&gt;
  &lt;img alt="cheatsheet-figures/squash.svg" src="On the left a dm object where table A is linked to table B and table C. Table D is linked to table B. On the right a table corresponding to a join of table A, B, C and D as they can all be reached from table A albeit indirectly."/&gt;
  &lt;figcaption&gt;&lt;pre&gt;&lt;code class="language-r"&gt;dm1 |&amp;gt;</code></pre>

dm_flatten_to_tbl( .start = df1, .recursive = TRUE ) 



<pre><code>&lt;/figure&gt;</code></pre>


<h3 id="single-tibble-dm-dm_wrap_tbl">Single tibble dm:
<code>dm_wrap_tbl()</code>
</h3>


<p>Parent tables are packed — <code>dm_pack_tbl()</code>.</p>


<p>Child tables are nested — <code>dm_nest_tbl()</code>.</p>


<pre><code>&lt;figure class="big"&gt;
  &lt;img alt="cheatsheet-figures/dm_wrap_tbl.svg" src="On the left a dm object (tables with arrows in a frame) where a green table is linked to a parent blue table and a child purple table. On the right another dm object with a single table in a frame. The blue parent table became a packed column in the green table (a column that contains a data frame) and the purple child table became a nested table (a table in each cell)."/&gt;
  &lt;figcaption&gt;&lt;pre&gt;&lt;code class="language-r"&gt;dm1 |&amp;gt;</code></pre>

dm_wrap_tbl( root = green_df ) 



<pre><code>&lt;/figure&gt;</code></pre>


<h3 id="retrieve-one-table-of-the-dm-pull_tbl">Retrieve one table of the
dm: <code>pull_tbl()</code>
</h3>


<pre><code>&lt;figure class="big"&gt;
  &lt;img alt="cheatsheet-figures/pull-keyed.svg" src="On the left a dm object with three tables, on the right only a table. The primary key information has been kept which is represented by the first column of that table having kept its dark background."/&gt;
  &lt;figcaption&gt;&lt;pre&gt;&lt;code class="language-r"&gt;dm1 |&amp;gt;</code></pre>

pull_tbl( dm1, green_df, keyed = TRUE ) 



<pre><code>&lt;/figure&gt;



&lt;figure class="big"&gt;
  &lt;img alt="cheatsheet-figures/pull2.svg" src="On the left a dm object with three tables. There is a magnifying glass on the green table. On the right only the green table."/&gt;
  &lt;figcaption&gt;&lt;p&gt;If the dm is zoomed, retrieve zoomed table automatically.&lt;/p&gt;</code></pre>


<pre><code class="language-r">dm1 |&gt;
  dm_zoom_to(green_df) |&gt;
pull_tbl()
</code></pre>



<pre><code>&lt;/figure&gt;</code></pre>

        </div>        <div class="col col-md-4">         

<h2>
<i class="fa-solid fa-screwdriver-wrench"></i> Mutate, create,
analyze tables</h2>


<h3 id="method-1-deconstruct-and-reconstruct">
<i class="fa-solid fa-hammer"></i>
Method 1: deconstruct and reconstruct</h3>


<ol style="list-style-type: decimal">
<li>
<p><code>dm_get_tables(keyed = TRUE)</code>: <br> to keep
information on primary and foreign keys).</p>
<figure class><p><img alt="cheatsheet-figures/deconstruct.svg" src="diagram%20showing%20the%20transformation%20from%20left%20a%20dm%20object%20to%20right%20a%20named%20list%20of%20the%20same%20table,%20instead%20of%20a%20solid%20border%20frame%20on%20the%20right%20the%20frame%20has%20a%20dotted%20border"></p>
<figcaption><pre><code class="language-r">dm_tbl &lt;- dm1 |&gt;
  dm_get_tables(keyed = TRUE)
</code></pre>
</figcaption></figure>
</li>
<li>
<p>tidyverse pipeline on the table of interest.</p>
<figure class="right"><p><img alt="cheatsheet-figures/mutate.svg" src="on%20the%20left%20a%20table,%20on%20the%20right%20the%20same%20table%20with%20one%20more%20column"></p>
<figcaption><pre><code class="language-r">new_table1 &lt;- dm_tbl$table1 |&gt;
  mutate(...)
</code></pre>
</figcaption></figure>
</li>
<li>
<p>Optional: update the dm object:</p>
<figure class="right"><p><img alt="cheatsheet-figures/reconstruct.svg" src="on%20the%20left%20a%20dm%20of%20three%20tables,%20on%20the%20right%20the%20same%20dm%20but%20one%20of%20the%20tables%20has%20one%20column%20more"></p>
<figcaption><pre><code class="language-r">dm1 |&gt;
  dm_select_tbl(-table1) |&gt;
  dm(table1 = new_table1)
</code></pre>
</figcaption></figure>
</li>
</ol>

<h3 id="method-2-zoom">
<i class="fa-solid fa-magnifying-glass"></i>
Method 2: zoom</h3>


<ol style="list-style-type: decimal">
<li>
<p><code>dm_zoom_to()</code>: Zoom on a table.</p>
<figure class="right"><p><img alt="cheatsheet-figures/zoom1.svg" src="On%20the%20left%20a%20dm%20object%20with%20three%20tables.%20On%20the%20right%20the%20same%20object%20but%20there%20is%20now%20a%20magnifying%20glass%20on%20the%20green%20table."></p>
<figcaption><pre><code class="language-r">zoomed_dm1 &lt;- dm1 |&gt;
  dm_zoom_to(green_df)
</code></pre>
</figcaption></figure>
</li>
<li>
<p>tidyverse pipeline (<code>mutate()</code>, etc.).</p>
<figure class="right"><p><img alt="cheatsheet-figures/zoom2.svg" src="On%20the%20left%20a%20dm%20object%20with%20three%20tables%20including%20a%20green%20table%20with%20a%20magnifying%20glass%20on%20it.%20On%20the%20right%20the%20same%20object%20but%20there%20is%20now%20a%20second%20green%20table%20superimposed,%20with%20one%20more%20column%20compared%20to%20the%20green%20table%20in%20the%20dm."></p>
<figcaption><pre><code class="language-r">zoomed_dm2 &lt;- zoomed_dm1 |&gt;
  mutate(var = thing)
</code></pre>
</figcaption></figure>
</li>
<li>
<p><code>dm_update_zoomed()</code> (replace) /
<code>dm_insert_zoomed()</code></p>
<figure class="right"><p><img alt="cheatsheet-figures/zoom3.svg" src="On%20the%20left%20a%20dm%20object%20featuring%20a%20second%20green%20table%20superimposed,%20with%20one%20more%20column%20compared%20to%20the%20green%20table%20in%20the%20dm.%20On%20the%20right%20the%20magnifying%20glass%20and%20second%20green%20table%20disappeared.%20Instead%20the%20green%20table%20in%20the%20dm%20has%20the%20new%20column."></p>
<figcaption><pre><code class="language-r">dm3 &lt;- zoomed_dm2 |&gt;
  dm_update_zoomed()
</code></pre>
</figcaption></figure>
</li>
</ol>        </div>        <div class="col col-md-4">         

<h2 id="modify-database-source-of-a-dm">
<i class="fa-solid fa-database"></i>
Modify database source of a dm</h2>


<h3 id="export-dm-object-to-database-copy_dm_to">
<i class="fa-solid fa-download"></i>
Export dm object to database: <code>copy_dm_to()</code>
</h3>


<p>Need a <strong>database connection —
<code>DBI::dbConnect()</code></strong>.</p>


<pre><code>&lt;figure class="right"&gt;
  &lt;img alt="cheatsheet-figures/copy_dm.svg" src="On the left a dm object, with an arrow pointing to on the right a database icon"/&gt;
  &lt;figcaption&gt;&lt;pre&gt;&lt;code class="language-r"&gt;con &amp;lt;- DBI::dbConnect(...)</code></pre>


<p># Persistent tables: persistent_dm &amp;lt;- copy_dm_to( con, dm1,
temporary = FALSE )</p>

DBI::dbDisconnect(con) 



<pre><code>&lt;/figure&gt;</code></pre>


<h2 id="insert-update-or-remove-rows-in-a-dm">
<i class="fa-solid fa-plus-minus"></i>
Insert, update or remove rows in a dm</h2>


<p>Methods:</p>


<ul>
<li>
<code>dm_rows_insert(dm1, dm2)</code>: adds new rows</li>
<li>
<code>dm_rows_update(dm1, dm2)</code>: changes values in rows</li>
<li>
<code>dm_rows_patch(dm1, dm2)</code>: fills in missing values</li>
<li>
<code>dm_rows_upsert(dm1, dm2)</code>: adds new or changes rows</li>
<li>
<code>dm_rows_delete(dm1, dm2)</code>: deletes rows</li>
</ul>

<pre><code>dm1 |&gt;
dm_rows_insert(dm2, in_place = FALSE)</code></pre>


<pre><code>&lt;figure class="left"&gt;
  &lt;img alt="cheatsheet-figures/insert2.svg" src="Equal sign then a dm object where the blue table has now more rows."/&gt;&lt;img alt="cheatsheet-figures/insert1.svg" src="On the left a dm object with 3 tables. On the right, a similar dm where one of the tables, the blue one, has more rows. Between the two is a plus sign"/&gt;
  &lt;figcaption&gt;&lt;/figcaption&gt;
&lt;/figure&gt;</code></pre>


<pre class="r"><code>dm1 |&gt;
dm_rows_insert(dm2, in_place = TRUE)</code></pre>


<pre><code>&lt;figure class="left"&gt;
  &lt;img alt="cheatsheet-figures/insert4.svg" src="Database icon."/&gt;&lt;img alt="cheatsheet-figures/insert3.svg" src="On the left a dm object with 3 tables, and a database icon superimposed. On the right, a similar dm where one of the tables, the blue one, has more rows. Between the two is a plus sign"/&gt;
  &lt;figcaption&gt;&lt;/figcaption&gt;
&lt;/figure&gt;</code></pre>


<p>A dm is immutable, except with</p>


<ul>
<li>
<i class="fa-solid fa-check"></i> these functions AND</li>
<li>
<i class="fa-solid fa-check"></i> a mutable backend (database)
AND</li>
<li>
<i class="fa-solid fa-check"></i> <code>in_place = TRUE</code>.</li>
</ul>        </div>      </div>    </div>    </div></body>
