#' Add tables to a [`dm`]
#'
#' @description
#' `dm_add_tbl()` adds one or more tibbles to a [`dm`].
#' It uses [mutate()] semantics.
#'
#' @return The inital `dm` with the additional table(s).
#'
#' @seealso [dm_rm_tbl()]
#'
#' @param dm A [`dm`] object
#' @param ... One or more tibbles to add to the `dm`.
#'   If no explicit name is given, the name of the expression is used.
#' @inheritParams vctrs::vec_as_names
#'
#' @export
dm_add_tbl <- function(dm, ..., repair = "check_unique") {

  check_dm(dm)

  new_names <- names(exprs(..., .named = TRUE))
  new_tables <- list(...)

  check_new_tbls(dm, new_tables)

  old_names <- src_tbls(dm)
  all_names <- vctrs::vec_as_names(c(old_names, new_names), repair = repair)

  new_old_names <- all_names[seq_along(old_names)]

  selected <- set_names(old_names, new_old_names)
  dm <- dm_select_tbl_impl(dm, selected)

  new_names <- all_names[seq2(length(old_names) + 1, length(all_names))]
  dm_add_tbl_impl(dm, new_tables, new_names)
}

dm_add_tbl_impl <- function(dm, tbls, table_name) {
  def <- dm_get_def(dm)

  def_0 <- def[rep_along(table_name, NA_integer_), ]
  def_0$table <- table_name
  def_0$data <- tbls
  def_0$pks <- vctrs::list_of(new_pk())
  def_0$fks <- vctrs::list_of(new_fk())
  def_0$filters <- vctrs::list_of(new_filter())

  new_dm3(vctrs::vec_rbind(def, def_0))
}

#' Remove tables from a [`dm`]
#'
#' @description
#' Removes one or more tibbles from a [`dm`].
#'
#' @return The inital `dm` without the removed table(s).
#'
#' @seealso [dm_add_tbl()], [dm_select_tbl()]
#'
#' @param dm A [`dm`] object
#' @param ... One or more unquoted tibble names to remove from the `dm`.
#'
#' @export
dm_rm_tbl <- function(dm, ...) {
  check_dm(dm)

  table_names <-
    ensyms(..., .named = FALSE) %>%
    map_chr(~ as_name(.))

  check_correct_input(dm, table_names)

  dm_select_tbl(dm, -one_of(!!!table_names))
}


check_new_tbls <- function(dm, tbls) {
  orig_tbls <- dm_get_tables(dm)

  # are all new tables on the same source as the original ones?
  if (has_length(orig_tbls) && !all_same_source(c(orig_tbls[1], tbls))) {
    abort_not_same_src()
  }
}

